<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Day Sülalesi Soyağacı</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<style>
:root {
  --bg-color: #f8fafc;
  --card-bg: #ffffff;
  --primary: #3b82f6;
  --border: #e2e8f0;
  --text-dark: #1e293b;
  --text-light: #64748b;
}

html, body {
  height: 100%;
  margin: 0;
  padding: 0;
  background-color: var(--bg-color);
  font-family: "Segoe UI", Roboto, sans-serif;
  color: var(--text-dark);
  overflow: hidden;
}

header {
  background: var(--card-bg);
  padding: 20px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  text-align: center;
  width: 100%;
  position: fixed;
  top: 0;
  z-index: 10;
}

h1 {
  margin: 0;
  font-size: 2rem;
  color: var(--primary);
}

.container {
  position: absolute;
  top: 100px;
  left: 0;
  right: 0;
  bottom: 0;
  overflow: hidden;
  padding: 0 10px;
  box-sizing: border-box;
}

.explanation {
  background-color: #eef6ff;
  border: 1px solid #d0e3ff;
  padding: 15px;
  border-radius: 8px;
  font-size: 1em;
  margin-bottom: 10px;
  line-height: 1.6;
}

.explanation strong { color: var(--primary); }

.new-entry-link {
  display: inline-block;
  margin-top: 10px;
  font-weight: 600;
  color: #16a34a;
  text-decoration: none;
}

.new-entry-link:hover { text-decoration: underline; }

#chart_div {
  width: 100%;
  height: 100%;
  position: relative;
  touch-action: none;
}

.chart-zoom-wrapper {
  position: absolute;
  transform-origin: center center;
  left: 50%;
  top: 50%;
  transition: transform 0.05s linear;
}

.person-node {
  background: #f9fafb;
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 5px 3px;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  width: 100px;
  transition: all 0.2s ease;
  position: relative;
}

.person-node:hover {
  background: #f1f5f9;
  transform: scale(1.04);
}

.profile-pic {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  object-fit: cover;
  margin-bottom: 4px;
  border: 1px solid #e2e8f0;
}

.name {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-dark);
  max-width: 90px;
  word-wrap: break-word;
  line-height: 1.2em;
}

.toggle-icon {
  margin-top: 6px;
  background: var(--primary);
  color: white;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  font-size: 14px;
  line-height: 18px;
  cursor: pointer;
  user-select: none;
  display: inline-block;
}

.details-icon {
  position: absolute;
  top: 2px;
  right: 4px;
  cursor: pointer;
  color: var(--primary);
  font-weight: bold;
  font-size: 1em;
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.4);
  backdrop-filter: blur(3px);
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.2);
}

.close {
  float: right;
  font-size: 26px;
  color: #aaa;
  cursor: pointer;
}
.close:hover { color: var(--primary); }

.modal-content img {
  width: 100%;
  max-height: 180px;
  object-fit: contain;
  border-radius: 8px;
  margin-bottom: 10px;
}

.modal-content h2 {
  margin-top: 0;
  color: var(--primary);
  font-size: 1.3rem;
  text-align: center;
}

.modal-content p {
  margin: 8px 0;
  font-size: 0.95rem;
}

@media (max-width: 768px) {
  h1 { font-size: 1.5rem; }
  .explanation { font-size: 0.9em; }
  .person-node { width: 70px; }
  .name { max-width: 70px; font-size: 10px; }
  .profile-pic { width: 35px; height: 35px; }
}
</style>

<script>
const GAS_API_URL = "https://script.google.com/macros/s/AKfycby8UHbXQCHBU6gWCE_Fqiuem6WT6W_JVAa5_ij4vdB0thwaePT_VzL46dAXrJ6ciOPb/exec";
const FORM_LINKI = "https://docs.google.com/forms/d/1nyG8pPEeuIZyYE_gPN05CfqqEDc4izi78-m7GdCaPJM/viewform";
let familyData = [];
let collapsedNodes = new Set();
let scale = 1;
let panX = 0;
let panY = 0;
let startX, startY, isPanning = false;
let pinchStartDistance = null;
let pinchStartScale = 1;

google.charts.load('current', {packages:["orgchart"]});
google.charts.setOnLoadCallback(fetchFamilyData);

function fetchFamilyData() {
  fetch(GAS_API_URL)
    .then(res => res.json())
    .then(data => drawChart(data))
    .catch(err => console.error("Veri hatası:", err));
}

function drawChart(dataArray) {
  familyData = dataArray;
  const dataTable = new google.visualization.DataTable();
  dataTable.addColumn('string', 'Name');
  dataTable.addColumn('string', 'Parent');
  dataTable.addColumn('string', 'ToolTip');

  for (const person of familyData) {
    const imageUrl = person.base64Image || 'https://via.placeholder.com/60?text=NO_PIC';
    const nameDisplay = person.id.split(' - ')[0] || person.id;
    const hasChild = familyData.some(p => p.parent === person.id);
    const toggleBtn = hasChild ? `<div class="toggle-icon" onclick="toggleNode(event, '${person.id}')">${collapsedNodes.has(person.id) ? '+' : '−'}</div>` : '';
    const tooltip = `${person.description || ''}`;

    const nodeHTML = `
      <div class="person-node" data-id="${person.id}">
        <img src="${imageUrl}" class="profile-pic" onerror="this.src='https://via.placeholder.com/40?text=NO'">
        <div class="name">${nameDisplay}</div>
        ${toggleBtn}
        <div class="details-icon" onclick="showDetails(event, '${person.id}')">ⓘ</div>
      </div>`;

    dataTable.addRow([{v: person.id, f: nodeHTML}, person.parent || '', tooltip]);
  }

  const chartWrapper = document.createElement('div');
  chartWrapper.className = 'chart-zoom-wrapper';
  const chartContainer = document.getElementById('chart_div');
  chartContainer.innerHTML = '';
  chartContainer.appendChild(chartWrapper);

  const chart = new google.visualization.OrgChart(chartWrapper);
  chart.draw(dataTable, {allowHtml: true});
  collapsedNodes.forEach(id => hideChildren(id));
  centerChart();
  enablePanAndPinch(chartContainer, chartWrapper);
}

function centerChart() {
  const wrapper = document.querySelector('.chart-zoom-wrapper');
  const rect = wrapper.getBoundingClientRect();
  panX = window.innerWidth / 2 - rect.width / 2;
  panY = window.innerHeight / 2 - rect.height / 2;
  wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
}

function enablePanAndPinch(container, wrapper) {
  container.addEventListener('mousedown', (e) => {
    isPanning = true;
    startX = e.clientX - panX;
    startY = e.clientY - panY;
  });
  container.addEventListener('mouseup', () => isPanning = false);
  container.addEventListener('mouseleave', () => isPanning = false);
  container.addEventListener('mousemove', (e) => {
    if (!isPanning) return;
    panX = e.clientX - startX;
    panY = e.clientY - startY;
    wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
  });

  container.addEventListener('touchstart', (e) => {
    if (e.touches.length === 1) {
      isPanning = true;
      startX = e.touches[0].clientX - panX;
      startY = e.touches[0].clientY - panY;
    } else if (e.touches.length === 2) {
      isPanning = false;
      pinchStartDistance = getPinchDistance(e);
      pinchStartScale = scale;
    }
  });

  container.addEventListener('touchmove', (e) => {
    e.preventDefault();
    if (e.touches.length === 1 && isPanning) {
      panX = e.touches[0].clientX - startX;
      panY = e.touches[0].clientY - startY;
    } else if (e.touches.length === 2) {
      const newDistance = getPinchDistance(e);
      const pinchRatio = newDistance / pinchStartDistance;
      scale = Math.min(Math.max(0.3, pinchStartScale * pinchRatio), 3);
    }
    wrapper.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
  });

  container.addEventListener('touchend', () => {
    isPanning = false;
    pinchStartDistance = null;
  });
}

function getPinchDistance(e) {
  const dx = e.touches[0].clientX - e.touches[1].clientX;
  const dy = e.touches[0].clientY - e.touches[1].clientY;
  return Math.sqrt(dx*dx + dy*dy);
}

function toggleNode(event, id) {
  event.stopPropagation();
  const icon = event.target;
  if (collapsedNodes.has(id)) {
    collapsedNodes.delete(id);
    showChildren(id);
    icon.textContent = '−';
  } else {
    collapsedNodes.add(id);
    hideChildren(id);
    icon.textContent = '+';
  }
}

function hideChildren(parentId) {
  document.querySelectorAll('.person-node').forEach(r => {
    const id = r.getAttribute('data-id');
    const nodeData = familyData.find(p => p.id === id);
    if (nodeData && nodeData.parent === parentId) {
      r.closest('tr').style.display = 'none';
      hideChildren(id);
    }
  });
}

function showChildren(parentId) {
  document.querySelectorAll('.person-node').forEach(r => {
    const id = r.getAttribute('data-id');
    const nodeData = familyData.find(p => p.id === id);
    if (nodeData && nodeData.parent === parentId) {
      r.closest('tr').style.display = '';
      if (!collapsedNodes.has(id)) showChildren(id);
    }
  });
}

function showDetails(event, id) {
  event.stopPropagation();
  const person = familyData.find(p => p.id === id);
  if (!person) return;
  const dateObj = new Date(person.birthDate);
  const birthDateDisplay = !isNaN(dateObj.getTime()) ? dateObj.toLocaleDateString('tr-TR') : 'Bilinmiyor';
  const imageUrl = person.base64Image || person.imageUrl || 'https://via.placeholder.com/200?text=No+Image';
  const html = `
    <img src="${imageUrl}" onerror="this.style.display='none'">
    <h2>${person.id.split(' - ')[0]}</h2>
    <p><strong>Doğum Tarihi:</strong> ${birthDateDisplay}</p>
    <p><strong>Telefon:</strong> ${person.phone || 'Yok'}</p>
    <p><strong>Açıklama:</strong> ${person.description || 'Yok'}</p>
    ${person.imageUrl ? `<p><a href="${person.imageUrl}" target="_blank">Orijinal Fotoğrafı Gör</a></p>` : ''}`;
  document.getElementById('modal-content').innerHTML = html;
  document.getElementById('details-modal').style.display = 'block';
}

function closeModal() {
  document.getElementById('details-modal').style.display = 'none';
}
</script>
</head>
<body>
<header>
  <h1>👨‍👩‍👧‍👦 Day Sülalesi Soyağacı</h1>
</header>

<div class="container">
  <div class="explanation">
    Bu soyağacı <strong>Berat Day</strong> tarafından dinamik olarak oluşturulmuştur. Yapılan herhangi bir girişte düzenleme aynı isim ve tarih seçerek oluşturulabilmektedir. 
    Farklı isimle yanlışlıkla oluşturulan yeni, olmayan bir aile bireyi için iletişime geçiniz. Olası karışıklıklara mahal vermemek adına farklı bir durum oluştuğunda düzenleme ve revizyon için iletişime geçiniz.
    İletişim için <strong>05434813373</strong>.
    <br><br>
    Buradan kişiler ekleyebilir ve güncelleyebilirsiniz:
    <a href="javascript:void(0);" onclick="window.open(FORM_LINKI, '_blank');" class="new-entry-link">
      + Yeni Kişi / Güncelleme Formu
    </a><br>
  </div>
  <div id="chart_div">Yükleniyor...</div>
</div>

<div id="details-modal" class="modal" onclick="closeModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modal-content"></div>
  </div>
</div>
</body>
</html>


